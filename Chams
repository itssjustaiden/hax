local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local CoreGui = game:GetService("CoreGui")

local ESP_ENABLED = false
local CHAMS = {}

local function makeCham(char)
	if not char or not char:IsA("Model") then return end
	if CHAMS[char] then return end
	local highlight = Instance.new("Highlight")
	highlight.Name = "ZESP_CHAM"
	highlight.Adornee = char
	highlight.FillColor = Color3.new(1, 1, 1)
	highlight.FillTransparency = 0.5
	highlight.OutlineTransparency = 1
	highlight.Parent = CoreGui
	CHAMS[char] = highlight
end

local function clearCham(char)
	if CHAMS[char] then
		CHAMS[char]:Destroy()
		CHAMS[char] = nil
	end
end

local function refreshESP()
	if not ESP_ENABLED then return end
	for _, plr in pairs(Players:GetPlayers()) do
		if plr ~= LocalPlayer and plr.Character then
			makeCham(plr.Character)
		end
	end
end

local function setupPlayer(plr)
	plr.CharacterAdded:Connect(function(char)
		task.wait(1)
		if ESP_ENABLED then
			makeCham(char)
		end
	end)
end

for _, plr in pairs(Players:GetPlayers()) do
	if plr ~= LocalPlayer then
		setupPlayer(plr)
	end
end

Players.PlayerAdded:Connect(setupPlayer)

local function createToggleUI()
	local screenGui = Instance.new("ScreenGui")
	screenGui.Name = "ESPToggleUI"
	screenGui.ResetOnSpawn = false
	screenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

	local toggleBtn = Instance.new("TextButton")
	toggleBtn.Name = "ToggleESP"
	toggleBtn.Size = UDim2.new(0, 60, 0, 30)
	toggleBtn.Position = UDim2.new(0, 10, 1, -40)
	toggleBtn.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
	toggleBtn.TextColor3 = Color3.new(1, 1, 1)
	toggleBtn.TextScaled = true
	toggleBtn.BorderSizePixel = 0
	toggleBtn.Text = "OFF"
	toggleBtn.Parent = screenGui

	toggleBtn.MouseButton1Click:Connect(function()
		ESP_ENABLED = not ESP_ENABLED
		toggleBtn.Text = ESP_ENABLED and "ON" or "OFF"
		if ESP_ENABLED then
			refreshESP()
		else
			for char, _ in pairs(CHAMS) do
				clearCham(char)
			end
		end
	end)

	toggleBtn.Active = true
	toggleBtn.Draggable = true
end

LocalPlayer.CharacterAdded:Connect(function()
	task.wait(1)
	if not LocalPlayer.PlayerGui:FindFirstChild("ESPToggleUI") then
		createToggleUI()
	end
end)

createToggleUI()

RunService.Heartbeat:Connect(function()
	if ESP_ENABLED then
		for char, highlight in pairs(CHAMS) do
			if not char.Parent then
				clearCham(char)
			end
		end
	end
end)
